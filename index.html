<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>نقشه نهایی با مرزهای دقیق</title>

    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        :root {
            --neon-red: #ff3b30;
            --glass-bg: rgba(35, 35, 35, 0.75);
            --text-color: #f5f5f7;
            --success-color: #34c759;
            --flag-fill-opacity: 0.75; /* شفافیت پرچم */
        }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000; font-family: 'Vazirmatn', sans-serif;
        }
        #map-container {
            width: 100%; height: 100%; position: relative;
        }
        #location-map {
            width: 100%; height: 100%; background-color: #111;
        }
        .search-container {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 360px; background: var(--glass-bg);
            border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            display: flex; align-items: center; padding: 6px 12px;
            z-index: 1001; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: opacity 0.3s, transform 0.3s;
        }
        .search-container input {
            flex-grow: 1; background: transparent; border: none;
            outline: none; color: var(--text-color); font-size: 15px;
            font-family: 'Vazirmatn', sans-serif; text-align: right;
        }
        .search-container input::placeholder { color: rgba(235, 235, 245, 0.6); }
        .search-container .icon-container {
            width: 22px; height: 22px; margin-left: 10px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .spinner {
            width: 18px; height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .custom-controls {
            position: absolute; left: 25px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 10px;
            z-index: 1000;
        }
        .control-box {
            background: var(--glass-bg); border-radius: 22px; border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            padding: 5px; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-decoration: none;
        }
        .control-box button {
            background: transparent; border: none; color: var(--text-color);
            font-size: 22px; font-weight: 500; width: 34px; height: 34px;
            cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s;
            line-height: 34px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
        }
        .control-box button:hover, a.control-box:hover { background-color: rgba(255, 255, 255, 0.1); }
        .separator { width: 24px; height: 1px; background-color: rgba(255, 255, 255, 0.2); }

        .neon-border {
            stroke: var(--neon-red); stroke-width: 2.5px; stroke-opacity: 1;
            fill-opacity: var(--flag-fill-opacity);
            filter: drop-shadow(0 0 4px var(--neon-red));
            stroke-dasharray: 4000; stroke-dashoffset: 4000;
            animation: draw-line 4s ease-out forwards;
        }
        .neon-border-simple { /* استایل برای غیر-کشورها */
             fill-opacity: 0.2;
             fill: var(--neon-red);
        }
        @keyframes draw-line { to { stroke-dashoffset: 0; } }

        #toast {
            position: absolute; top: -100px; left: 50%;
            transform: translateX(-50%); padding: 10px 20px; border-radius: 10px;
            background-color: var(--success-color); color: white; font-weight: 500;
            z-index: 2000; transition: top 0.5s ease-in-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        #toast.show { top: 20px; }
        #toast.error { background-color: var(--neon-red); }

        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: var(--glass-bg); color: var(--text-color); border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .leaflet-popup-content {
            font-size: 13px; font-weight: 500; margin: 10px !important;
            text-align: right; line-height: 1.6;
        }
        .leaflet-popup-close-button { color: var(--text-color) !important; }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="toast"></div>
        <div class="search-container">
            <input type="text" id="location-input" placeholder="نام کشور یا شهر را وارد کنید...">
            <div id="icon-container" class="icon-container">
                <svg id="search-icon" class="icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            </div>
        </div>
        <div class="custom-controls">
            <div class="control-box">
                <button id="zoom-in">+</button>
                <div class="separator"></div>
                <button id="zoom-out">−</button>
            </div>
        </div>
        <div id="location-map"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let featureLayer = null;
            let isSearching = false;
            let countriesData = null; // برای نگهداری لیست کشورها
            let countryBorders = null; // برای نگهداری مرزهای دقیق کشورها

            const locationInput = document.getElementById('location-input');
            const iconContainer = document.getElementById('icon-container');
            const toast = document.getElementById('toast');
            const searchIconHTML = iconContainer.innerHTML;
            const spinnerHTML = '<div class="spinner"></div>';
            
            const map = L.map('location-map', { zoomControl: false }).setView([30, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            const svg = d3.select(map.getPanes().overlayPane).select("svg");
            const svgDefs = svg.append("defs");

            // --- Event Listeners ---
            iconContainer.addEventListener('click', handleSearch);
            locationInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') handleSearch();
            });
            document.getElementById('zoom-in').addEventListener('click', () => map.zoomIn());
            document.getElementById('zoom-out').addEventListener('click', () => map.zoomOut());
            
            // --- Preload Data ---
            async function preloadData() {
                toggleLoading(true, true); // Show indefinite spinner
                showToast("در حال بارگذاری داده‌های نقشه...");
                try {
                    const [bordersResponse, countriesResponse] = await Promise.all([
                        fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson'),
                        fetch('https://restcountries.com/v3.1/all?fields=name,cca2,cca3,capital,population,flags')
                    ]);
                    countryBorders = await bordersResponse.json();
                    countriesData = await countriesResponse.json();
                    showToast("داده‌ها با موفقیت بارگذاری شد", false);
                } catch (error) {
                    console.error("Failed to preload data:", error);
                    showToast("خطا در بارگذاری داده‌های اولیه", true);
                } finally {
                     toggleLoading(false);
                }
            }

            // --- Core Functions ---
            function clearLayer() {
                if (featureLayer) {
                    map.removeLayer(featureLayer);
                    featureLayer = null;
                }
                svgDefs.selectAll("*").remove();
            }
            
            function toggleLoading(loading, isInitial = false) {
                isSearching = loading;
                if(isInitial){
                   iconContainer.innerHTML = spinnerHTML; 
                } else {
                   iconContainer.innerHTML = loading ? spinnerHTML : searchIconHTML;
                }
            }

            function showToast(message, isError = false) {
                toast.textContent = message;
                toast.className = isError ? 'show error' : 'show';
                setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 4000);
            }

            async function handleSearch() {
                const query = locationInput.value.trim().toLowerCase();
                if (!query || isSearching || !countriesData || !countryBorders) {
                    if(!countriesData || !countryBorders) showToast("داده‌های نقشه هنوز بارگذاری نشده‌اند. لطفاً صبر کنید.", true);
                    return;
                };
                
                toggleLoading(true);
                clearLayer();

                // Step 1: Try to find as a country from our pre-loaded accurate list
                const country = findCountry(query);

                if (country) {
                    await drawCountry(country);
                } else {
                    // Step 2: If not a country, search as a general location using Nominatim
                    await searchAndDrawGeneralLocation(query);
                }
                toggleLoading(false);
            }

            function findCountry(query) {
                return countriesData.find(c => 
                    c.name.common.toLowerCase() === query ||
                    c.name.official.toLowerCase() === query ||
                    (c.cca2 && c.cca2.toLowerCase() === query) ||
                    (c.cca3 && c.cca3.toLowerCase() === query)
                );
            }

            async function drawCountry(country) {
                const borderFeature = countryBorders.features.find(f => f.properties.ISO_A3 === country.cca3);
                if (!borderFeature) {
                    showToast(`مرز دقیقی برای ${country.name.common} یافت نشد.`, true);
                    return;
                }

                // Create flag pattern
                const flagUrl = country.flags.svg;
                const patternId = `flag-pattern-${country.cca2}`;
                svgDefs.append("pattern")
                    .attr("id", patternId)
                    .attr("patternUnits", "objectBoundingBox")
                    .attr("width", 1).attr("height", 1)
                    .append("image")
                    .attr("href", flagUrl)
                    .attr("x", 0).attr("y", 0)
                    .attr("width", 1).attr("height", 1)
                    .attr("preserveAspectRatio", "xMidYMid slice");
                
                const style = { className: 'neon-border', fillPattern: `url(#${patternId})` };
                
                featureLayer = L.geoJSON(borderFeature, { style: style });

                const population = country.population.toLocaleString('fa-IR');
                const popupContent = `
                    <b>${country.name.common}</b><br>
                    پایتخت: ${country.capital ? country.capital[0] : 'N/A'}<br>
                    جمعیت: ${population} نفر`;
                
                featureLayer.bindPopup(popupContent);
                featureLayer.addTo(map);
                map.flyToBounds(featureLayer.getBounds(), { padding: [50, 50] });
            }

            async function searchAndDrawGeneralLocation(query) {
                try {
                    const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(query)}&polygon_geojson=1&limit=1`;
                    const response = await fetch(nominatimUrl);
                    const data = await response.json();

                    if (!data || data.length === 0 || !data[0].geojson) {
                        showToast(`مکان "${query}" یافت نشد.`, true);
                        return;
                    }

                    const location = data[0];
                    const style = { className: 'neon-border neon-border-simple' };
                    featureLayer = L.geoJSON(location.geojson, { style: style });
                    featureLayer.bindPopup(`<b>${location.display_name}</b>`);
                    featureLayer.addTo(map);
                    map.flyToBounds(featureLayer.getBounds(), { padding: [50, 50] });

                } catch (error) {
                    console.error("Nominatim search failed:", error);
                    showToast("خطا در جستجوی مکان.", true);
                }
            }
            
            // --- Initial Load ---
            preloadData().then(() => {
                locationInput.value = "Iran";
                handleSearch();
            });
        });
    </script>
</body>
</html>
