<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>نقشه هوشمند کشورها (نسخه یکپارچه)</title>

    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        :root {
            --neon-red: #ff3b30;
            --glass-bg: rgba(35, 35, 35, 0.75);
            --text-color: #f5f5f7;
            --success-color: #34c759;
            --flag-fill-opacity: 0.7; /* شفافیت پرچم روی نقشه */
        }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000; font-family: 'Vazirmatn', sans-serif;
        }
        #map-container {
            width: 100%; height: 100%; position: relative;
        }
        #location-map {
            width: 100%; height: 100%; background-color: #111;
        }
        .search-container {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 360px; background: var(--glass-bg);
            border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            display: flex; align-items: center; padding: 6px 12px;
            z-index: 1001; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: opacity 0.3s, transform 0.3s;
        }
        .search-container input {
            flex-grow: 1; background: transparent; border: none;
            outline: none; color: var(--text-color); font-size: 15px;
            font-family: 'Vazirmatn', sans-serif; text-align: right;
        }
        .search-container input::placeholder { color: rgba(235, 235, 245, 0.6); }
        .search-container .icon-container {
            width: 22px; height: 22px; margin-left: 10px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .search-container .icon {
            fill: var(--text-color); width: 100%; height: 100%;
            opacity: 0.7; transition: opacity 0.2s;
        }
        .search-container .icon-container:hover .icon { opacity: 1; }
        .spinner {
            width: 18px; height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .custom-controls {
            position: absolute; left: 25px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 10px;
            z-index: 1000;
            transition: opacity 0.3s, transform 0.3s;
        }
        .control-box {
            background: var(--glass-bg);
            border-radius: 22px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            padding: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-decoration: none;
        }
        .control-box button {
            background: transparent; border: none; color: var(--text-color);
            font-size: 22px; font-weight: 500; width: 34px; height: 34px;
            cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s;
            line-height: 34px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
        }
        .control-box button:hover, a.control-box:hover { background-color: rgba(255, 255, 255, 0.1); }
        .control-box .icon { fill: var(--text-color); width: 20px; height: 20px; }
        .instagram-icon { width: 24px; height: 24px; margin: 5px; opacity: 0.8; }
        a.control-box:hover .instagram-icon { opacity: 1; }
        .separator {
            width: 24px;
            height: 1px;
            background-color: rgba(255, 255, 255, 0.2);
        }

        body.ui-hidden .search-container,
        body.ui-hidden .custom-controls {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-50%) scale(0.95);
        }

        .neon-border {
            stroke: var(--neon-red);
            stroke-width: 3px;
            stroke-opacity: 1;
            fill-opacity: var(--flag-fill-opacity);
            filter: drop-shadow(0 0 5px var(--neon-red));
            stroke-dasharray: 2000;
            stroke-dashoffset: 2000;
            animation: draw-line 5s ease-out forwards;
        }
        @keyframes draw-line { to { stroke-dashoffset: 0; } }

        #toast {
            position: absolute; top: -100px; left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 10px;
            background-color: var(--success-color);
            color: white;
            font-weight: 500;
            z-index: 2000;
            transition: top 0.5s ease-in-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        #toast.show { top: 20px; }
        #toast.error { background-color: var(--neon-red); }

        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: var(--glass-bg);
            color: var(--text-color);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .leaflet-popup-content {
            font-size: 13px;
            font-weight: 500;
            margin: 10px !important;
            text-align: right;
            line-height: 1.6;
        }
        .leaflet-popup-close-button { color: var(--text-color) !important; }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="toast"></div>
        <div class="search-container">
            <input type="text" id="location-input" placeholder="نام کشور را وارد کنید (مثال: Iran)">
            <div id="icon-container" class="icon-container">
                <svg id="search-icon" class="icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            </div>
        </div>
        <div class="custom-controls">
            <div class="control-box">
                <button id="zoom-in">+</button>
                <div class="separator"></div>
                <button id="zoom-out">−</button>
            </div>
            <div class="control-box">
                <button id="toggle-layer">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M12,16L19.36,10.27L21,9L12,2L3,9L4.63,10.27L12,16M12,18.54L4.63,12.81L3,14.07L12,21.07L21,14.07L19.37,12.8L12,18.54Z" /></svg>
                </button>
            </div>
            <a href="https://www.instagram.com/dy3o.n" target="_blank" class="control-box">
                <svg class="icon instagram-icon" viewBox="0 0 24 24"><path d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z" /></svg>
            </a>
            <div class="control-box fullscreen-box">
                 <button id="fullscreen-toggle">
                     <svg class="icon" viewBox="0 0 24 24"><path d="M5,15H7V19H11V21H5V15M7,5H5V9H3V5H5V3H9V5H7M19,21H17V19H13V17H19V21M17,5V3H13V5H15V9H17V5Z" /></svg>
                 </button>
            </div>
        </div>
        <div id="location-map"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Global Variables & Constants ---
            let featureLayers = [];
            let isSearching = false;
            let countryBordersGeoJSON = null; // To store the large borders file

            const locationInput = document.getElementById('location-input');
            const iconContainer = document.getElementById('icon-container');
            const searchIconHTML = iconContainer.innerHTML;
            const spinnerHTML = '<div class="spinner"></div>';
            const toast = document.getElementById('toast');

            const layers = [
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' }),
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' }),
                L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'], attribution: '&copy; Google' }),
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' })
            ];
            const layerNames = ["تاریک", "ماهواره‌ای", "ترکیبی", "ساده"];
            let currentLayerIndex = 0;

            // --- Map Initialization ---
            const map = L.map('location-map', { zoomControl: false, layers: [layers[0]] }).setView([30, 0], 2);
            
            // Add an SVG element to the map pane for flag patterns, using D3.js
            const svg = d3.select(map.getPanes().overlayPane).select("svg");
            const svgDefs = svg.append("defs");

            // --- Event Listeners ---
            iconContainer.addEventListener('click', () => handleSearch());
            locationInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') handleSearch();
            });
            document.getElementById('zoom-in').addEventListener('click', () => map.zoomIn());
            document.getElementById('zoom-out').addEventListener('click', () => map.zoomOut());
            document.getElementById('toggle-layer').addEventListener('click', cycleMapLayer);
            document.getElementById('fullscreen-toggle').addEventListener('click', () => document.body.classList.toggle('ui-hidden'));
            
            // --- Core Functions ---

            /**
             * Pre-fetches the GeoJSON file with all country borders for efficiency.
             */
            async function preloadCountryBorders() {
                try {
                    // This file contains the borders of all countries
                    const response = await fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson');
                    if (!response.ok) throw new Error('Network response was not ok');
                    countryBordersGeoJSON = await response.json();
                    console.log("Country borders loaded successfully.");
                } catch (error) {
                    console.error("Failed to load country borders:", error);
                    showToast("خطا در بارگذاری مرزهای جهانی", true);
                }
            }

            /**
             * Handles the search logic when the user initiates a search.
             */
            async function handleSearch() {
                const query = locationInput.value.trim();
                if (!query || isSearching) return;
                
                toggleLoading(true);
                clearAllLayers();

                try {
                    const countryData = await getCountryInfo(query);
                    if (!countryData) {
                         throw new Error(`کشوری با نام "${query}" یافت نشد.`);
                    }

                    const countryGeoJsonFeature = findCountryGeometry(countryData.cca3);
                    if (!countryGeoJsonFeature) {
                        throw new Error(`مرزهای جغرافیایی برای ${countryData.name.common} یافت نشد.`);
                    }

                    displayCountryOnMap(countryData, countryGeoJsonFeature);

                } catch (error) {
                    showToast(error.message, true);
                } finally {
                    toggleLoading(false);
                }
            }

            /**
             * Fetches detailed information for a country from the REST Countries API.
             */
            async function getCountryInfo(countryName) {
                const response = await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(countryName)}?fields=name,capital,population,flags,cca3`);
                if (!response.ok) return null;
                const data = await response.json();
                return data[0]; // Return the first result which is usually the best match
            }

            /**
             * Finds the specific GeoJSON geometry for a country from the preloaded data.
             */
            function findCountryGeometry(countryCodeISOA3) {
                if (!countryBordersGeoJSON) return null;
                return countryBordersGeoJSON.features.find(
                    feature => feature.properties.ISO_A3 === countryCodeISOA3
                );
            }
            
            /**
             * Displays the country's border and flag on the map.
             */
            function displayCountryOnMap(countryData, geoJsonFeature) {
                const flagUrl = countryData.flags.svg;
                const countryCode = countryData.cca3;

                // Create a unique SVG pattern for the country's flag
                const patternId = `flag-pattern-${countryCode}`;
                svgDefs.append("pattern")
                    .attr("id", patternId)
                    .attr("patternUnits", "objectBoundingBox")
                    .attr("width", 1)
                    .attr("height", 1)
                    .append("image")
                    .attr("href", flagUrl) // Use "href" for D3 v7
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", 1)
                    .attr("height", 1)
                    .attr("preserveAspectRatio", "xMidYMid slice");

                // Create the GeoJSON layer with the flag pattern as fill
                const layer = L.geoJSON(geoJsonFeature, {
                    style: {
                        className: 'neon-border', // For the animated border
                        fillPattern: `url(#${patternId})` // Apply the flag pattern
                    }
                }).addTo(map);

                // Create informative popup
                const population = countryData.population.toLocaleString('fa-IR');
                const popupContent = `
                    <b>${countryData.name.common} (${countryData.name.official})</b><br>
                    پایتخت: ${countryData.capital[0]}<br>
                    جمعیت: ${population} نفر
                `;
                layer.bindPopup(popupContent).openPopup();
                
                featureLayers.push(layer);
                map.flyToBounds(layer.getBounds(), { padding: [50, 50] });
            }

            // --- Utility Functions ---

            function clearAllLayers() {
                featureLayers.forEach(layer => map.removeLayer(layer));
                featureLayers = [];
                svgDefs.selectAll("*").remove(); // Clear old flag patterns
            }

            function cycleMapLayer() {
                map.removeLayer(layers[currentLayerIndex]);
                currentLayerIndex = (currentLayerIndex + 1) % layers.length;
                map.addLayer(layers[currentLayerIndex]);
                showToast(`نقشه ${layerNames[currentLayerIndex]} فعال شد`);
            }

            function toggleLoading(loading) {
                isSearching = loading;
                iconContainer.innerHTML = loading ? spinnerHTML : searchIconHTML;
            }

            function showToast(message, isError = false) {
                toast.textContent = message;
                toast.className = isError ? 'show error' : 'show';
                setTimeout(() => {
                    toast.className = toast.className.replace('show', '');
                }, 4000);
            }

            // --- Initial Load ---
            // First, load the border data. Then, search for the initial country.
            preloadCountryBorders().then(() => {
                locationInput.value = "Iran";
                handleSearch();
            });
        });
    </script>
</body>
</html>
